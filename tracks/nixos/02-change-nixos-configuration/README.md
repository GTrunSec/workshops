# Overview

As described in the introduction, NixOS is a GNU/Linux distribution with a
declarative system configuration manager. The whole operating system is built by
the Nix package manager from a description in a purely functional language, also
called Nix.

For the purpose of this section, we'll consider the Nix language as a black box,
and we'll treat `configuration.nix` as a configuration file with a slightly
alien syntax.


## For those at the Melbourne :: Compose 2019 workshop

We've already changed the configuration in our NixOS system to ensure we can use
mdns and to set up a local proxy-cache to download packages from. We did it in
two steps:

1. we edited the `configuration.nix` file
2. we ran the `nixos-rebuild` command

The current section of the workshop will address how to achieve different goals
using these two tools: edit configuration and rebuild.


## Structure of /etc/nixos/configuration.nix

A `configuration.nix` file is really a function definition in the Nix language.
It usually starts with `{config, pkgs, ... }:` which means it takes two
arguments: config and pkgs. Then it returns a set of option definitions
(key/value pairs of the form `{ option = definition; }`) that, processed by
nixos-rebuild, updates the system. We'll explain later how this works.


We've included a sample file in the repo that we recommend you look
at as you go through this description. @@TODO (JC) INCLUDE SAMPLE
configuration.nix FILE

@@TODO(JC) finish description of NixOS modules.
@@QUESTION(JC) Why do we have top level keys like `users` and `imports` that aren't a NixOS module? What are they?

```
[kandinski@desire:~/data/work/hack/nixos/nixpkgs/nixos/modules]$ ls
config  hardware  i18n  installer  misc  module-list.nix  profiles  programs  rename.nix  security  services  system  tasks  testing  virtualisation
```


  - `imports`: Nix files are modular, and `configuration.nix` is no exception.
    The default `configuration.nix` generated by a clean instal with
    `nixos-install` will generate a second `hardware-configuration.nix` that
    gets imported at the head of the file.
  - `nix`: Configuration details for the nix package manager itself. For
    instance, you can add new binary caches for built packages, keys for
  - `nixpkgs`: Configuration details fnstance,  r the nixpkgs channels.  
     - Overrides is what this is useful for.
  - `hardware`
  - `boot`
  - `time`
  - `i18n`
  - `virtualisation`
  - `environment`
  - `services`
  - `users`

    @@TODO(JS) FINISH DESCRIPTION OF TOP NAMES IN CONFIGURATION.NIX "NAMESPACE"
    @@TODO(JS) ADD EXAMPLES OF WHAT THEY ARE USED FOR, 



## `nixos-rebuild`: what it says on the tin

The nixos-rebuild command takes a NixOS system in a working state and a
`configuration.nix` file, and returns a changed working state according to the
configuration file. Here are the most common subcommands:

  - `nixos-rebuild switch`: Build the new system configuration, activate it and
    add it to GRUB as the new default boot option.
  - `nixos-rebuild boot`: Build the new system configuration and add it to GRUB
    as the new default boot option, but don't activate it. The system continues
    running the previous configuration.
  - `nixos-rebuild test`: Build the new system configuration and activate it,
    but don't add it to GRUB as the new default boot option, but don't activate
    it. If you need to reboot, the new configuration won't be available on the
    boot menu.
  - `nixos-rebuild build`: Build the new system configuration, but don't
    activate it nor add it to the GRUB boot menu.

Other subcommands are useful for debugging by performing dry runs or building
qemu virtual machines. Check `man nixos-rebuild` if you want to learn more.

The `nixos-rebuild` command also has options. Here are the most common:

  - `--upgrade`: fetches the latest version of NixOS from the NixOS channel
    before rebuilding.
  - `--install-bootloader`: use to reinstall the bootloader after changing the
    device configuration.
  - `--no-build-nix`: usually, nixos-rebuild first builds the latest version of
    the Nix package manager before rebuilding. This option disables this.
  - `--fast`: equivalent to `--no-build-nix --show-trace`. Use when you're
    calling `nixos-rebuild` frequently.
  - `--rollback`: Don't build a new configuration based on
    /etc/nixos/configuration.nix. Rather, roll back the previous configuration.
  
More options allow you to declare remote builders, change profiles (GRUB
submenus) to install your new configuration at, and even target a different host
to activate the new configuration on. As always, check `man nixos-rebuild`.


## Now type this:

@@TODO(JC) Think of useful exercises/examples in changing the configuration.

## What's next
